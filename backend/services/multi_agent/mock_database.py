"""
컨설팅 Agent용 가상 데이터베이스 (Mock Database)
- 5개 대학 입결 통계 (서울대, 연세대, 고려대, 성균관대, 경희대)
- 정시 점수 환산 방법
"""

# ============================================================
# 수시 합격 데이터 (내신 기준)
# ============================================================

ADMISSION_DATA_SUSI = {
    "학생부교과": {
        "서울대-지역균형": {"최저내신": 1.2, "평균내신": 1.7, "최고내신": 2.3},
        "고려대-학교추천": {"최저내신": 1.5, "평균내신": 2.1, "최고내신": 2.8},
        "연세대-추천형": {"최저내신": 1.8, "평균내신": 2.3, "최고내신": 3.0},
        "성균관대-학교장추천": {"최저내신": 1.8, "평균내신": 2.5, "최고내신": 3.2},
        "경희대-고교연계": {"최저내신": 2.5, "평균내신": 3.2, "최고내신": 4.0},
    },
    "학생부종합": {
        "서울대-일반전형": {"최저내신": 1.0, "평균내신": 1.5, "최고내신": 2.5, "비고": "서류+면접 중요"},
        "고려대-일반전형": {"최저내신": 1.2, "평균내신": 1.8, "최고내신": 3.0, "비고": "서류+면접 중요"},
        "연세대-활동우수형": {"최저내신": 1.3, "평균내신": 2.0, "최고내신": 3.2, "비고": "비교과 중요"},
        "성균관대-계열모집": {"최저내신": 1.5, "평균내신": 2.2, "최고내신": 3.5, "비고": "서류 100%"},
        "경희대-네오르네상스": {"최저내신": 2.0, "평균내신": 2.8, "최고내신": 4.2, "비고": "서류+면접"},
    }
}

# ============================================================
# 정시 합격 데이터 (백분위 기준)
# ============================================================

ADMISSION_DATA_JEONGSI = {
    "가군": {
        "연세대-인문": {"최저백분위": 93, "평균백분위": 95.5, "최고백분위": 99},
        "연세대-자연": {"최저백분위": 91, "평균백분위": 94.2, "최고백분위": 98},
        "고려대-인문": {"최저백분위": 94, "평균백분위": 96.0, "최고백분위": 99},
        "고려대-자연": {"최저백분위": 92, "평균백분위": 95.0, "최고백분위": 98},
        "성균관대-인문": {"최저백분위": 90, "평균백분위": 93.5, "최고백분위": 97},
        "성균관대-자연": {"최저백분위": 88, "평균백분위": 92.0, "최고백분위": 96},
    },
    "나군": {
        "서울대-인문": {"최저백분위": 96, "평균백분위": 98.0, "최고백분위": 100},
        "서울대-자연": {"최저백분위": 94, "평균백분위": 97.0, "최고백분위": 100},
        "경희대-인문": {"최저백분위": 83, "평균백분위": 87.5, "최고백분위": 93},
        "경희대-자연": {"최저백분위": 80, "평균백분위": 85.0, "최고백분위": 91},
    },
    "다군": {
        "경희대-인문(다)": {"최저백분위": 80, "평균백분위": 85.0, "최고백분위": 91},
        "경희대-자연(다)": {"최저백분위": 77, "평균백분위": 82.5, "최고백분위": 89},
    }
}

# ============================================================
# 정시 점수 환산 방법 (5개 대학)
# ============================================================

SCORE_CONVERSION = {
    "서울대": {
        "정시": {
            "국어": {"반영비율": 33.3, "계산": "표준점수 사용"},
            "수학": {"반영비율": 40.0, "계산": "표준점수 사용"},
            "탐구": {"반영비율": 26.7, "계산": "표준점수 사용, 2과목 평균"},
            "영어": {"등급별가산점": {1: 0, 2: -0.5, 3: -1, 4: -1.5, 5: -2, 6: -2.5}},
            "특이사항": "2028학년도부터 교과평가 40% 반영"
        }
    },
    "연세대": {
        "정시": {
            "국어": {"반영비율": 33.3, "계산": "백분위 사용"},
            "수학": {"반영비율": 33.3, "계산": "백분위 사용"},
            "탐구": {"반영비율": 33.3, "계산": "백분위 사용, 2과목 평균"},
            "영어": {"등급별감점": {1: 0, 2: -5, 3: -10, 4: -15, 5: -20}},
            "특이사항": "영어 등급별 감점제"
        }
    },
    "고려대": {
        "정시": {
            "국어": {"반영비율": 35.0, "계산": "표준점수 사용"},
            "수학": {"반영비율": 35.0, "계산": "표준점수 사용"},
            "탐구": {"반영비율": 30.0, "계산": "백분위 사용, 2과목 평균"},
            "영어": {"등급별점수": {1: 100, 2: 98, 3: 95, 4: 90, 5: 80}},
            "특이사항": "국수 표준점수, 탐구 백분위 혼합"
        }
    },
    "성균관대": {
        "정시": {
            "국어": {"반영비율": 30.0, "계산": "백분위 사용"},
            "수학": {"반영비율": 40.0, "계산": "백분위 사용"},
            "탐구": {"반영비율": 30.0, "계산": "백분위 사용, 2과목 평균"},
            "영어": {"등급별점수": {1: 100, 2: 95, 3: 87.5, 4: 75, 5: 60}},
            "특이사항": "수학 반영비율 높음"
        }
    },
    "경희대": {
        "정시": {
            "국어": {"반영비율": 35.0, "계산": "백분위 사용"},
            "수학": {"반영비율": 35.0, "계산": "백분위 사용"},
            "탐구": {"반영비율": 30.0, "계산": "백분위 사용, 2과목 평균"},
            "영어": {"등급별점수": {1: 200, 2: 196, 3: 188, 4: 176, 5: 160}},
            "특이사항": "영어 200점 만점 환산"
        }
    }
}


# ============================================================
# DB 조회 함수들
# ============================================================

def get_admission_data_by_grade(grade: float, admission_type: str = "전체") -> dict:
    """내신 등급 기준 합격 가능 대학 조회"""
    result = {"합격가능": [], "도전가능": [], "상향지원": []}

    data_sources = []
    if admission_type in ["전체", "학생부교과"]:
        data_sources.append(("학생부교과", ADMISSION_DATA_SUSI.get("학생부교과", {})))
    if admission_type in ["전체", "학생부종합"]:
        data_sources.append(("학생부종합", ADMISSION_DATA_SUSI.get("학생부종합", {})))

    for type_name, data in data_sources:
        for univ_type, values in data.items():
            avg = values.get("평균내신", 0)
            max_grade = values.get("최고내신", 0)

            if grade <= avg:
                result["합격가능"].append({
                    "전형": f"{type_name}-{univ_type}",
                    "평균내신": avg,
                    "내등급과차이": round(avg - grade, 2)
                })
            elif grade <= max_grade:
                result["도전가능"].append({
                    "전형": f"{type_name}-{univ_type}",
                    "평균내신": avg,
                    "최고내신": max_grade,
                    "내등급과차이": round(avg - grade, 2)
                })
            elif grade <= max_grade + 0.5:
                result["상향지원"].append({
                    "전형": f"{type_name}-{univ_type}",
                    "평균내신": avg,
                    "최고내신": max_grade,
                    "내등급과차이": round(avg - grade, 2)
                })

    # 정렬
    for key in result:
        result[key] = sorted(result[key], key=lambda x: x.get("평균내신", 0))

    return result


def get_jeongsi_data_by_percentile(percentile: float) -> dict:
    """백분위 기준 정시 합격 가능 대학 조회"""
    result = {"합격가능": [], "도전가능": [], "상향지원": []}

    for group, universities in ADMISSION_DATA_JEONGSI.items():
        for univ_type, values in universities.items():
            avg = values.get("평균백분위", 0)
            min_pct = values.get("최저백분위", 0)

            if percentile >= avg:
                result["합격가능"].append({
                    "군": group,
                    "대학-계열": univ_type,
                    "평균백분위": avg,
                    "내백분위와차이": round(percentile - avg, 1)
                })
            elif percentile >= min_pct:
                result["도전가능"].append({
                    "군": group,
                    "대학-계열": univ_type,
                    "평균백분위": avg,
                    "최저백분위": min_pct,
                    "내백분위와차이": round(percentile - avg, 1)
                })
            elif percentile >= min_pct - 2:
                result["상향지원"].append({
                    "군": group,
                    "대학-계열": univ_type,
                    "평균백분위": avg,
                    "최저백분위": min_pct,
                    "내백분위와차이": round(percentile - avg, 1)
                })

    return result


def get_score_conversion_info(university: str) -> dict:
    """대학별 점수 환산 방법 조회"""
    if university in SCORE_CONVERSION:
        return {university: SCORE_CONVERSION[university]}
    return {"error": f"{university} 점수 환산 정보가 없습니다."}


def get_all_universities_data() -> dict:
    """5개 대학 전체 데이터 반환"""
    return {
        "수시_합격데이터": ADMISSION_DATA_SUSI,
        "정시_합격데이터": ADMISSION_DATA_JEONGSI,
        "점수환산방법": SCORE_CONVERSION
    }
