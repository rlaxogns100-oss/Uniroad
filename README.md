# 수능 점수 변환 및 입시 컨설팅 시스템

2026 수능 실제 데이터를 기반으로 **등급·표준점수·원점수·백분위**를 서로 변환하고, LLM Function Calling 결과를 정규화하여 **입시 컨설팅용 프롬프트**를 생성하는 시스템입니다.

**궁극적 목표**: 사용자가 성적을 입력하면 **지원 가능한 모든 대학·전공 리스트**를 보여주는 **합격 진단 리버스 서치** 기능을 제공합니다. 현재는 2025학년도 고려대학교 정시 입결 데이터를 기반으로 DB를 구축하고, 일반전형(1000점)·교과우수전형(800점) 비교 로직을 구현한 상태입니다.

---

## 목차

- [프로젝트 개요](#프로젝트-개요)
- [디렉터리 구조](#디렉터리-구조)
- [모듈 설명](#모듈-설명)
- [합격 진단 리버스 서치](#합격-진단-리버스-서치)
- [대학별 정시 환산 계산기](#대학별-정시-환산-계산기)
- [입력 형식](#입력-형식)
- [실행 방법](#실행-방법)
- [테스트](#테스트)
- [요약](#요약)

---

## 프로젝트 개요

| 항목 | 설명 |
|------|------|
| **목적** | 수능 성적(등급/표준점수/원점수)을 통일된 형식으로 변환하고, 입시 상담용 텍스트 프롬프트 생성 |
| **궁극 목표** | 성적 입력 시 **지원 가능 대학·전공 리스트**(리버스 서치) 제공 → 안정/적정/소신/상향 판정 |
| **데이터 기준** | 2026 수능 (국어/수학 표준점수, 사회·과학탐구 원점수, 등급컷) + 입결 JSON(예: 2025 고려대 정시) |
| **활용** | LLM Function Calling으로 추출한 성적 JSON → 정규화 → 컨설팅 프롬프트(대학별 환산 + 리버스 서치 표) |
| **대학별 환산** | target_univ에 포함된 대학(경희대·고려대·서강대·서울대·연세대)에 대해 해당 대학 산출식으로 환산 점수 계산 → **[대학명 환산 점수]** 섹션 출력 |

### 처리 흐름

```
[LLM Function Calling 결과] → normalize_scores_from_extracted() → 정규화된 성적
                                                      ↓
                    process_consult_call(params)
                                                      ↓
         ┌──────────────────────────────────────────┴──────────────────────────────────────────┐
         │ target_univ 비어 있음 또는 "어디 갈 수 있어?" 포함                                      │
         │   → run_reverse_search(normalized) → data/admission_results/*.json과 비교              │
         │   → 프롬프트 최상단에 "지원 가능 대학 및 학과 분석 (리버스 서치)" Markdown 표 추가           │
         └──────────────────────────────────────────────────────────────────────────────────────┘
                                                      ↓
         target_univ에 포함된 대학별 환산 점수 산출 (UNIV_CONVERTED_CALCULATORS)
                                                      ↓
                            컨설팅 프롬프트 (리버스 서치 표 + 성적 + [대학별 환산 점수] + 상담 요청)
```

---

## 디렉터리 구조

역할별로 데이터·로직·앱·테스트를 분리했습니다.

```
점수_to_등급/
├── data/                        # 데이터 계층
│   ├── __init__.py
│   ├── standard.py              # 2026 수능: 국어/수학/탐구/등급컷, 영어·한국사 등급
│   └── admission_results/       # 입결 데이터 (리버스 서치용)
│       └── korea_2025.json      # 2025학년도 고려대 정시 (일반 1000/800, 교과우수 800)
├── core/                        # 로직 계층
│   ├── __init__.py
│   └── converter.py             # ScoreConverter (표준점수·원점수·등급·백분위 변환)
├── app/                         # 애플리케이션 계층
│   ├── __init__.py
│   ├── processor.py             # 정규화, process_consult_call, 리버스 서치 섹션 삽입
│   ├── search_engine.py         # 리버스 서치 엔진 (입결 JSON vs 환산 점수 비교)
│   └── calculators/            # 대학별 정시 환산 계산기
│       ├── __init__.py
│       ├── khu.py               # 경희대 (600점, 4계열)
│       ├── korea.py             # 고려대 (1000점 인문·자연 + 교과우수 800점, track 감지)
│       ├── sogang.py            # 서강대 (A/B형, 영어·한국사 가산)
│       ├── snu.py               # 서울대 (1000점, 7모집단위)
│       └── yonsei.py            # 연세대 (1000점, 7모집단위)
├── tests/
│   ├── __init__.py
│   └── test_score_converter.py  # 실제 데이터 기반 통합·단위 테스트
├── main.py                      # 실행 진입점 (샘플 시나리오)
├── .env                         # 환경 설정 (필요 시)
└── README.md
```

---

## 모듈 설명

### 1. `data/` (데이터 계층)

- **`data/standard.py`**: 2026 수능 기준 원시 데이터(국어/수학 표준점수, 사회·과학탐구 원점수, 등급컷, 영어·한국사 등급). 대학별 변환표·감점은 `app/calculators/` 각 모듈에 정의.
- **`data/admission_results/`**: 리버스 서치용 입결 JSON. 파일명 규칙 없음, `*.json` 배열 형태. 각 row에 `univ`, `major`, `type`, `field`, `cut_70_score`, `total_scale` 등 포함.

| 변수 (standard.py) | 설명 |
|--------------------|------|
| `korean_std_score_table` | 국어 **표준점수** → 등급, 백분위 |
| `math_std_score_table` | 수학 **표준점수** → 등급, 백분위 |
| `social_studies_data` | 사회탐구 **원점수** → 표준점수, 백분위, 등급 |
| `science_inquiry_data` | 과학탐구 **원점수** → 표준점수, 백분위, 등급 |
| `major_subjects_grade_cuts` | 국어/수학 **등급컷** (선택과목별) |
| `english_grade_data` / `history_grade_data` | 영어·한국사 절대평가 등급 |

### 2. `core/` (로직 계층)

`core/converter.py`의 **ScoreConverter**가 표준점수/원점수/등급/백분위 간 변환 및 보간·역추적을 담당합니다.

| 메서드 | 역할 |
|--------|------|
| `get_score_by_standard` | **표준점수** → 등급, 백분위 |
| `get_score_by_raw` | **원점수** → 표준점수, 등급, 백분위 |
| `estimate_score_by_grade` | **등급만** 주어졌을 때 해당 등급 중간 백분위로 표준점수 추정 |
| `find_closest_by_percentile` | **백분위**에 가장 가까운 점수 조회 |

### 3. `app/` (애플리케이션 계층)

| 구성요소 | 역할 |
|----------|------|
| `processor.py` | LLM이 넘겨준 성적 정규화, 리버스 서치 조건 시 `run_reverse_search` 호출 후 프롬프트 최상단에 표 삽입, target_univ 기준 대학별 환산 섹션 생성 |
| `search_engine.py` | `normalized_scores` → 입결 JSON과 비교 → 지원 가능 학과 리스트(판정 포함) 반환 |
| `calculators/` | 대학별 환산 점수 계산 (고려대는 일반+교과우수 동시 반환, 인문/자연 track 자동 감지) |

---

## 합격 진단 리버스 서치

사용자가 **희망 대학을 지정하지 않았을 때**(`target_univ` 비어 있음) 또는 **"어디 갈 수 있어?"**라고 물었을 때, **지원 가능한 대학·학과 리스트**를 프롬프트 최상단에 Markdown 표로 붙입니다.

### 동작 요약

1. **입력**: 정규화된 성적 `normalized_scores`
2. **계산**: 입결 데이터가 있는 대학만 `UNIV_CALCULATOR_MAP`으로 환산 점수 산출 (고려대: 일반 1000점 + 교과우수 800점, track=인문/자연)
3. **비교**: `data/admission_results/*.json` 각 row의 `type`(일반/교과우수), `field`(인문/자연)에 맞는 내 점수와 `cut_70_score` 비교. `total_scale`이 다르면 내 점수를 해당 스케일로 환산 후 비교
4. **판정**:
   - 내 점수 ≥ 컷 → 🟢 안정  
   - 내 점수 ≥ 컷 − 2 → 🟡 적정  
   - 내 점수 ≥ 컷 − 5 → 🔴 소신  
   - 그 미만 → ⚪ 상향  
5. **출력**: 대학·학과·전형·계열·컷·내 점수·판정·모집인원·경쟁률을 담은 리스트 → `process_consult_call`에서 **「지원 가능 대학 및 학과 분석 (리버스 서치)」** Markdown 표로 삽입

### 입결 JSON 형식 (예: `korea_2025.json`)

- **수능-일반전형(1000점)**과 **수능-교과우수전형(800점)**이 섞여 있으므로 `total_scale`, `type`을 반드시 저장합니다.
- `field`: "인문" | "자연" (사용자 track과 일치하는 row만 비교)

```json
{
  "univ": "고려대학교",
  "major": "경영대학",
  "recruit_count": 84,
  "competition_rate": 2.85,
  "cut_70_score": 654.12,
  "total_scale": 1000,
  "type": "일반",
  "field": "인문"
}
```

### 확장 방법

- 새 대학 입결 JSON을 `data/admission_results/`에 추가
- 해당 대학 환산 점수를 **일반/교과우수 + track** 형태로 반환하는 계산기를 구현한 뒤, `app/search_engine.py`의 `UNIV_CALCULATOR_MAP`에 대학명과 계산 함수 등록

---

## 대학별 정시 환산 계산기

`target_univ`에 아래 대학명(또는 키워드)이 포함되면, 해당 대학 산출식으로 환산한 **[대학명 환산 점수]** 섹션이 프롬프트에 추가됩니다.

| 대학 | 키워드 | 특징 |
|------|--------|------|
| **경희대** | 경희대, 경희대학교, KHU | 600점 만점, 4계열(인문/사회/자연/예술체육), 탐구 백분위→변환표준점수, 영어/한국사 감점, 자연계 과탐 가산점 |
| **고려대** | 고려대, 고려대학교, Korea | 1000점 환산(인문 560점 기준/자연 640점 기준), **일반+교과우수 동시 계산**. 사회/과학 탐구 변환표 구분, 인문/자연 track 자동 감지, 교과우수는 교과 만점 가정(800점). 반환: `일반`, `교과우수`, `track`, `계열별` |
| **서강대** | 서강대, 서강대학교, Sogang | A형(수학가중)/B형(국어가중) 중 높은 점수, 탐구 인문/자연/자유전공 별도 변환표, 영어/한국사 가산점 |
| **서울대** | 서울대, 서울대학교, SNU | 1000점 스케일, 7모집단위, 과탐 가산, 음악대학 특수 환산 |
| **연세대** | 연세대, 연세대학교, Yonsei | 1000점 만점, 7모집단위, 탐구 사탐/과탐 변환표, 탐구 가산 3% |

- 고려대 `calculate_korea_score(normalized_scores)` 반환: `{"일반": float, "교과우수": float, "track": "인문"|"자연", "계열별": {...}}`. processor는 `계열별`만 사용해 기존 포맷으로 출력하며, search_engine은 `일반`/`교과우수`/`track`만 사용합니다.
- 새 대학 추가: `app/calculators/`에 모듈 추가 → `processor.py`의 `UNIV_CONVERTED_CALCULATORS` 및 `_format_univ_converted_section`에 등록. 리버스 서치까지 넣으려면 `search_engine.UNIV_CALCULATOR_MAP`에도 등록(반환에 `일반`/`교과우수`/`track` 포함).

---

## 입력 형식

### 전체 파라미터 구조

```json
{
  "scores": {
    "국어": { "type": "등급" | "표준점수" | "원점수" | "백분위", "value": <숫자>, "선택과목": "화법과작문" },
    "수학": { ... },
    "영어": { "type": "등급", "value": 1 },
    "한국사": { "type": "등급", "value": 1 },
    "탐구1": { "type": "등급" | "원점수" | ..., "value": <숫자>, "과목명": "생활과윤리" },
    "탐구2": { ... }
  },
  "target_univ": ["서울대학교"] | [],
  "target_major": ["경영학과"],
  "user_message": "어디 갈 수 있어?",
  "query": "어디 갈 수 있어?"
}
```

- **`target_univ`** 비어 있거나 **`user_message`** / **`query`**에 `"어디 갈 수 있어"`가 포함되면 리버스 서치가 실행됩니다.
- `scores` 항목별 입력(국어/수학 선택과목, 탐구 과목명, 영어·한국사 등급 등)은 기존과 동일하며, 정규화 결과에 과목별 `과목명`, `등급`, `표준점수`, `백분위`, `원점수`, `비고`가 채워집니다.

---

## 실행 방법

프로젝트 루트에서 실행합니다.

### 기본 실행 (main.py)

```bash
python main.py
```

등급만 입력, 표준점수 입력, 원점수 입력 시나리오를 순서대로 실행하며, 각 시나리오별 **입력 → 정규화된 성적 → 생성된 컨설팅 프롬프트**를 출력합니다.  
리버스 서치를 보려면 `target_univ`를 비운 채로 `process_consult_call`을 호출하면 됩니다.

### 전체 테스트

```bash
python -m tests.test_score_converter
```

---

## 테스트

`tests/test_score_converter.py`는 실제 데이터 기반으로 동작을 검증합니다. 개별 기능(국어/수학 표준점수, 탐구 원점수, 등급 추정, 등급컷, 예외·경계) 및 통합 시나리오(전 과목 등급/표준점수/원점수 + `process_consult_call` 프롬프트)를 포함합니다.

---

## 요약

| 구분 | 내용 |
|------|------|
| **데이터** | `data/standard.py` — 2026 수능. `data/admission_results/*.json` — 입결(리버스 서치용) |
| **변환** | `core/converter.py` — 표준점수/원점수/등급/백분위 변환 및 보간·역추적 |
| **애플리케이션** | `app/processor.py` — 정규화, 리버스 서치 조건 시 표 삽입, 대학별 환산, 컨설팅 프롬프트 생성 |
| **리버스 서치** | `app/search_engine.py` — 입결 JSON과 환산 점수 비교, 안정/적정/소신/상향 판정 |
| **대학별 계산기** | `app/calculators/` — 경희대·고려대(일반+교과우수)·서강대·서울대·연세대 2026 정시 환산 |
| **입력** | `scores`(type, value, 선택과목/과목명) + `target_univ`, `target_major`, (선택) `user_message`/`query` |
| **실행** | `python main.py` (샘플), `python -m tests.test_score_converter` (전체 테스트) |
