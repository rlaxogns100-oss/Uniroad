# 토큰 사용량 추적 시스템

프로젝트의 모든 Gemini API 호출에서 토큰 사용량을 자동으로 기록합니다.

## 📁 파일 위치

- **로그 파일**: `token_usage.csv` (프로젝트 루트)
- **로거 모듈**: `token_logger.py`
- **통계 스크립트**: `view_token_stats.py`

## 🚀 사용 방법

### 1. 토큰 사용량 확인 (실시간)

백엔드 서버 실행 중인 터미널에서 실시간으로 확인:

```bash
cd backend
python main.py
```

파일 업로드나 채팅 시 터미널에 `💰` 아이콘과 함께 토큰 사용량이 출력됩니다.

### 2. 토큰 통계 보기

프로젝트 루트에서 통계 스크립트 실행:

```bash
python view_token_stats.py
```

또는:

```bash
./view_token_stats.py
```

출력 예시:
```
📊 토큰 사용량 통계
============================================================
💰 전체 사용량
   총 호출 횟수: 25회
   입력 토큰: 12,450
   출력 토큰: 8,320
   총 토큰: 20,770

📋 작업별 사용량
------------------------------------------------------------
   PDF파싱_청크        :   15,200 토큰 ( 10회) [입력:  9,500 / 출력:  5,700]
   오케스트레이션      :    2,300 토큰 (  5회) [입력:  1,200 / 출력:  1,100]
   최종답변생성        :    1,800 토큰 (  5회) [입력:  1,000 / 출력:    800]
   ...
```

### 3. CSV 파일 직접 열기

엑셀이나 스프레드시트로 `token_usage.csv` 파일을 열어서 상세 분석 가능:

| timestamp | operation | model | prompt_tokens | output_tokens | total_tokens | details |
|-----------|-----------|-------|---------------|---------------|--------------|---------|
| 2026-01-20 15:30:45 | PDF파싱_청크 | gemini-2.5-flash-lite | 1200 | 850 | 2050 | 청크 1 (페이지 1-5) |

## 📊 기록되는 작업 유형

- **PDF파싱_청크**: PDF 파일의 각 청크 파싱
- **PDF파싱_총합**: 전체 PDF 파싱 완료 시 총합
- **텍스트생성**: 일반 텍스트 생성
- **대화생성(Tools)**: 도구를 사용한 대화
- **문서정보추출**: 문서에서 정보 추출
- **오케스트레이션**: 멀티 에이전트 계획 수립
- **입결비교에이전트**: 입결 비교 작업
- **선생님에이전트**: 학습 조언 작업
- **최종답변생성**: Final Agent의 답변 생성

## 🧪 테스트 방법

1. **백엔드 서버 시작**
   ```bash
   cd backend
   python main.py
   ```

2. **PDF 파일 업로드**
   - 프론트엔드에서 관리자 페이지 접속
   - PDF 파일 하나 업로드

3. **터미널 확인**
   - 백엔드 터미널에서 `💰` 아이콘과 함께 토큰 사용량 확인

4. **통계 확인**
   ```bash
   python view_token_stats.py
   ```

5. **CSV 파일 확인**
   - `token_usage.csv` 파일 열어서 상세 내역 확인

## 💡 주의사항

- `token_usage.csv` 파일은 `.gitignore`에 추가되어 있지 않으므로, 민감한 정보가 포함될 경우 직접 추가하세요.
- 로그 파일이 너무 커지면 주기적으로 백업하고 삭제하는 것을 권장합니다.
- 모든 Gemini API 호출에서 자동으로 기록되므로, 별도 설정이 필요 없습니다.

## 🔧 커스터마이징

직접 토큰 사용량을 기록하려면:

```python
from token_logger import log_token_usage

log_token_usage(
    operation="내작업",
    prompt_tokens=100,
    output_tokens=50,
    total_tokens=150,
    model="gemini-2.0-flash",
    details="추가 정보"
)
```
