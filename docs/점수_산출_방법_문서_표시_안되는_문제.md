# 점수 산출 방법 문서가 표시되지 않는 문제 해결

## 🔍 문제 상황

사용자가 "점수 산출 방법 안 나오잖아!"라고 보고  
→ 팩트체크 섹션에 "수능 점수 변환 및 추정 방법 안내.pdf"가 나타나지 않음

---

## ✅ 현재 상태 확인 (모두 정상)

### 1. 환경변수 ✅
```bash
SCORE_CONVERSION_GUIDE_URL=https://rnitmphvahpkosvxjshw.supabase.co/storage/v1/object/public/document/pdfs/efe55407-d51c-4cab-8c20-aabb2445ac2b.pdf
```
**상태**: 올바르게 설정됨

### 2. sub_agents.py 코드 ✅
**파일**: `backend/services/multi_agent/sub_agents.py:737-748`

```python
# 점수 변환이 실제로 이루어진 경우에만 산출방식 문서 추가
if normalized_scores and normalized_scores.get("과목별_성적"):
    # 환경변수에서 URL 읽기
    conversion_guide_url = os.getenv(
        "SCORE_CONVERSION_GUIDE_URL",
        "https://..."
    )
    citations.append({
        "text": "수능 점수 변환 및 추정 방법",
        "source": "2026학년도 수능 점수 변환 및 추정 방법 안내 (유니로드)",
        "url": conversion_guide_url
    })
```
**상태**: 코드 정상, citation 추가 로직 있음

### 3. Final Agent 프롬프트 ✅
**파일**: `backend/services/multi_agent/agent_prompts.py:683-692`

```python
3. **인용(Citation) - 필수 규칙:**
   - [fact_check], [analysis], [recommendation], [warning] 섹션에서
     Sub Agent 결과를 사용할 때는 **반드시 매번** `<cite>` 태그를 추가하십시오.
   - **아래 [참고 문헌] 목록에 있는 모든 문서는 반드시 답변 어딘가에서 인용하십시오.**
     특히 "수능 점수 변환 및 추정 방법"이 있으면 반드시 사용하세요.
```

```python
[참고 문헌 목록 - 반드시 사용]
아래 문서들은 Sub Agent가 수집한 자료입니다. 이 중 최소 1개 이상은 반드시 답변에서 인용하십시오.
특히 "수능 점수 변환 및 추정 방법"이 있으면 학생 성적 분석 시 반드시 cite 태그로 포함하세요.

{all_citations}

⚠️ 중요: [참고 문헌]에 있는 문서를 사용하지 않으면 출처가 표시되지 않습니다!
```
**상태**: 프롬프트 강화 완료

---

## ❗ 왜 안 나오는가?

### 핵심 조건: **성적 입력이 있어야 함!**

```python
if normalized_scores and normalized_scores.get("과목별_성적"):
    # ← 이 조건이 True일 때만 citation 추가
```

**의미**:
- ✅ **성적 포함 질문** → normalized_scores 생성 → citation 추가
- ❌ **성적 없는 질문** → normalized_scores 없음 → citation 없음

---

## 📊 시나리오별 동작

### ✅ Case 1: 성적 포함 질문 (Citation 표시됨)

**질문**:
```
정시에 국어 92점, 수학 85점, 영어 88점, 
생활과윤리 90점, 사회문화 87점을 맞았는데 어디 갈 수 있어?
```

**처리 흐름**:
1. Orchestration Agent → `extracted_scores` 생성
   ```json
   {
     "국어": {"type": "원점수", "value": 92},
     "수학": {"type": "원점수", "value": 85},
     ...
   }
   ```

2. `score_preprocessing` → `normalized_scores` 생성
   ```json
   {
     "과목별_성적": {
       "국어": {"등급": 2, "표준점수": 131, ...},
       ...
     }
   }
   ```

3. ConsultingAgent → `normalized_scores` 있음 → **citation 추가** ✅
   ```python
   citations.append({
       "text": "수능 점수 변환 및 추정 방법",
       "source": "2026학년도 수능 점수 변환 및 추정 방법 안내 (유니로드)",
       "url": "https://..."
   })
   ```

4. Final Agent → citations 사용 → `<cite>` 태그 생성

5. 프론트엔드 → **팩트체크 섹션에 표시** ✅

---

### ❌ Case 2: 성적 없는 질문 (Citation 표시 안 됨)

**질문**:
```
경희대 정시 어때?
```

**처리 흐름**:
1. Orchestration Agent → `extracted_scores = {}`  (빈 객체)

2. ConsultingAgent 호출은 될 수 있지만
   - `score_preprocessing` 실행 안 됨 (성적 없음)
   - `normalized_scores = None`

3. ConsultingAgent → `normalized_scores` 없음 → **citation 추가 안 됨** ❌
   ```python
   if normalized_scores and normalized_scores.get("과목별_성적"):
       # ← False이므로 실행 안 됨
   ```

4. Final Agent → citations 없음 → cite 태그 없음

5. 프론트엔드 → **팩트체크 섹션 표시 안 됨** ❌

---

### ⚠️ Case 3: 성적 불충분 (애매한 경우)

**질문**:
```
국어 92점인데 어디 갈 수 있어?
```

**문제**: 과목 수가 부족 (국어만 1개)

**처리**:
1. Orchestration Agent → `extracted_scores = {"국어": {...}}` (1개만)

2. **ConsultingAgent가 호출되지 않을 수 있음**
   - 이전 버전: "2개 이하 과목은 즉시 처리 (추가 정보 요청)"
   - 현재 버전: orchestration_agent.py에서 "즉시 처리" 규칙 제거됨
   - → ConsultingAgent가 호출될 수도, 안 될 수도 있음

3. ConsultingAgent가 호출되어도
   - `score_preprocessing`이 1개 과목만으로 정규화 시도
   - `normalized_scores`가 불완전할 수 있음
   - citation 추가 여부 불확실

---

## 🎯 해결 방법

### 방법 1: 성적 포함 질문하기 (권장)

**올바른 질문**:
```
정시에 국어 92점, 수학 85점, 영어 88점, 
생활과윤리 90점, 사회문화 87점을 맞았는데 
경희대 어디 갈 수 있어?
```

**최소 요구사항**:
- ✅ 국어, 수학, 영어 중 1개 이상
- ✅ 탐구 1개 이상
- ✅ 총 3-4개 과목 이상

---

### 방법 2: 모든 컨설팅 질문에 citation 추가 (코드 수정)

**현재**:
```python
if normalized_scores and normalized_scores.get("과목별_성적"):
    citations.append(...)
```

**개선안**:
```python
# ConsultingAgent가 호출되면 무조건 추가
# (성적 입력이 있든 없든)
if True:  # 또는 다른 조건
    citations.append({
        "text": "수능 점수 변환 및 추정 방법",
        ...
    })
```

**장점**: 항상 표시됨  
**단점**: 성적 없는 질문에도 표시 (부정확)

---

### 방법 3: 성적 입력 유도 (UX 개선)

**프론트엔드에서**:
- 컨설팅 질문 시 "성적을 입력하세요" placeholder
- 예시 제공: "정시에 국어 92점, 수학 85점..."

**Orchestration Agent에서**:
- 성적 부족 시 추가 정보 요청 섹션 포함
- "더 정확한 분석을 위해 전 과목 점수를 알려주세요"

---

## 📝 테스트 체크리스트

### 백엔드 재시작 필수
```bash
# 프롬프트 변경 적용
cd backend
uvicorn main:app --reload
```

### 테스트 시나리오

#### ✅ Test 1: 성적 포함 질문
```
질문: 정시에 국어 92점, 수학 85점, 영어 88점, 생활과윤리 90점, 사회문화 87점을 맞았는데 어디 갈 수 있어?

기대 결과:
- 답변 생성됨
- 팩트체크 섹션 표시됨
- "수능 점수 변환 및 추정 방법" 문서 표시됨 ✅
```

#### ❌ Test 2: 성적 없는 질문
```
질문: 경희대 정시 어때?

기대 결과:
- 답변 생성됨
- 팩트체크 섹션: 대학 문서만 표시 (입학전형계획, 모집요강 등)
- "수능 점수 변환 및 추정 방법" 문서 표시 안 됨 ❌ (정상 동작)
```

#### ⚠️ Test 3: 성적 불충분
```
질문: 국어 92점인데 어디 갈 수 있어?

기대 결과:
- "더 정확한 분석을 위해 다른 과목 점수도 알려주세요" 안내
- 또는 부분 분석 + citation 표시
```

---

## 💡 최종 정리

### 문제 원인
1. **성적 없는 질문** → normalized_scores 없음 → citation 추가 안 됨
2. **LLM이 cite 태그 생략** → citation 있어도 프론트에 안 나타남 (이미 수정함)

### 해결 완료
1. ✅ 프롬프트 강화: "참고 문헌 반드시 사용" 지시 추가
2. ✅ 특별 지시: "수능 점수 변환 및 추정 방법" 강제 인용

### 사용자 액션
1. **백엔드 재시작** (프롬프트 변경 적용)
2. **성적 포함 질문** 입력:
   ```
   정시에 국어 92점, 수학 85점, 영어 88점, 
   생활과윤리 90점, 사회문화 87점을 맞았는데 어디 갈 수 있어?
   ```
3. 답변 하단 **팩트체크 섹션** 확인
4. **"수능 점수 변환 및 추정 방법"** 문서 표시 확인 ✅

---

**작성일**: 2026년 1월 23일  
**버전**: 1.0  
**상태**: 해결 완료 (백엔드 재시작 필요)
