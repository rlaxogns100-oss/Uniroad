# 출처 확인하기 기능 작동 원리

## 🔍 개요

**출처 확인하기** (팩트 체크)는 AI가 답변을 생성할 때 실제로 참조한 문서의 원문 조각들을 보여주는 기능입니다.

---

## 📊 전체 작동 흐름

```
1. 사용자 질문 입력
   ↓
2. Orchestration Agent: 필요한 정보 파악
   ↓
3. Sub Agents: 데이터베이스에서 관련 문서 검색
   ↓
4. Final Agent: 
   - 검색된 문서 청크들을 읽고 답변 생성
   - 답변 내 인용 부분을 <cite> 태그로 표시
   ↓
5. 인용된 청크만 추출 (_extract_cited_chunks_only)
   ↓
6. 프론트엔드: "팩트 체크" 섹션에 표시
```

---

## 🎯 핵심 메커니즘

### 1. Sub Agent가 문서 청크 수집 (`sub_agents.py`)

```python
# 대학별 Agent가 Supabase에서 문서 검색
results = supabase_service.search_documents(
    table="documents",
    query=query,
    k=5  # 최대 5개 청크
)

# 검색된 청크 예시:
{
    "id": "abc-123",
    "content": "경희대학교 2026학년도 정시 모집인원은 1,234명입니다...",
    "title": "경희대학교 2026학년도 모집요강",
    "source": "2026학년도 경희대 정시모집요강.pdf",
    "file_url": "https://supabase.co/.../khu_2026.pdf",
    "metadata": {...}
}
```

### 2. Final Agent가 청크 기반 답변 생성 (`final_agent.py`)

```python
# all_chunks: 모든 Sub Agent가 수집한 청크들의 합집합
all_chunks = []
for result in sub_agent_results.values():
    if result.get('citations'):
        all_chunks.extend(result['citations'])

# LLM에게 청크를 제공하며 답변 생성 요청
answer = llm.generate(
    prompt=f"다음 자료를 참고하여 답변하세요:\n{all_chunks}\n\n질문: {query}",
    instruction="출처를 인용할 때 <cite> 태그를 사용하세요"
)
```

**생성된 답변 예시**:
```
<cite data-source="2026학년도 경희대 정시모집요강.pdf" data-url="https://...">
경희대학교는 2026학년도 정시 전형에서 1,234명을 선발합니다.
</cite>
```

### 3. 실제 인용된 청크만 추출 (`_extract_cited_chunks_only`)

```python
def _extract_cited_chunks_only(self, answer: str, chunks: List[Dict]) -> List[Dict]:
    """
    답변에서 <cite> 태그로 실제 인용된 출처만 추출
    같은 PDF는 하나만 선택 (중복 제거)
    """
    # 1. 답변에서 <cite> 태그 파싱
    cite_pattern = r'<cite\s+data-source="([^"]*)"(?:\s+data-url="([^"]*)")?\s*>.*?</cite>'
    cited_sources = set()
    
    for match in re.finditer(cite_pattern, answer):
        source = match.group(1)
        cited_sources.add(source)
    
    # 예: {"2026학년도 경희대 정시모집요강.pdf", "2025학년도 입시결과.pdf"}
    
    # 2. 인용된 출처에 해당하는 청크만 필터링
    cited_chunks = []
    seen_documents = set()
    
    for chunk in chunks:
        chunk_source = chunk.get('source', '')
        document_name = extract_document_name(chunk_source)
        
        # 답변에서 실제 인용되었고 + 아직 추가 안 한 문서만
        if chunk_source in cited_sources and document_name not in seen_documents:
            cited_chunks.append(chunk)
            seen_documents.add(document_name)
    
    return cited_chunks
```

**결과**:
```python
used_chunks = [
    {
        "id": "abc-123",
        "content": "경희대학교 2026학년도 정시 모집인원은 1,234명입니다...",
        "title": "경희대학교 2026학년도 모집요강",
        "source": "2026학년도 경희대 정시모집요강.pdf",
        "file_url": "https://supabase.co/.../khu_2026.pdf"
    }
    # ... (답변에서 실제 인용된 문서만)
]
```

### 4. 프론트엔드에서 표시 (`ChatMessage.tsx`)

```tsx
{/* 팩트 체크 섹션 - 접을 수 있게 */}
{!isUser && used_chunks && used_chunks.length > 0 && (
  <details className="mt-4 bg-white rounded-xl border border-gray-200">
    <summary>
      <h3>팩트 체크</h3>
      <p>답변에 인용된 부분이에요</p>
    </summary>
    
    {/* 각 청크 표시 */}
    {used_chunks.map((chunk) => (
      <div>
        <p>{chunk.title}</p>  {/* 문서명 */}
        <p>{chunk.source}</p>  {/* 출처 */}
        <div>{chunk.content}</div>  {/* 원문 내용 */}
        <button onClick={handleDownload}>자료 다운</button>
      </div>
    ))}
  </details>
)}
```

---

## ✨ 주요 특징

### 1. **중복 제거**
- 같은 PDF 문서에서 여러 청크가 인용되어도 **하나만** 표시
- `seen_documents` Set으로 관리

### 2. **실제 인용된 것만**
- Sub Agent가 검색한 모든 청크 중
- Final Agent가 **실제로 답변에 사용한 청크만** 표시
- 검색은 했지만 안 쓴 문서는 제외

### 3. **원문 확인 가능**
- 청크의 `content` 필드에 원문이 저장됨
- AI가 해석/변형하기 전의 **실제 문서 내용** 확인 가능

### 4. **다운로드 기능**
- `file_url` 필드를 통해 원본 PDF 다운로드 가능
- 사용자가 직접 전체 문서 확인 가능

---

## 🔍 예시 시나리오

### 질문
```
"경희대 정시에서 경영학과는 몇 명 뽑아?"
```

### 처리 과정

1. **Orchestration Agent**: "경희대 agent 호출 필요"

2. **경희대 Agent**:
   - 데이터베이스 검색: "경희대 2026 정시 모집"
   - 5개 청크 반환:
     - 청크1: 모집요강 (모집인원 정보)
     - 청크2: 입시결과 (경쟁률 정보)
     - 청크3: 전형방법 (수능 반영비율)
     - 청크4: 학과 소개
     - 청크5: 학사일정

3. **Final Agent**:
   - 5개 청크를 모두 읽고 답변 생성
   - 실제로는 청크1, 청크2만 인용:
   ```
   <cite data-source="2026학년도 경희대 정시모집요강.pdf">
   경영학과는 정시 나군에서 50명을 선발합니다.
   </cite>
   
   <cite data-source="2025학년도 경희대 입시결과.pdf">
   작년 경쟁률은 15.3:1이었습니다.
   </cite>
   ```

4. **청크 추출**:
   - `_extract_cited_chunks_only` 실행
   - 청크1, 청크2만 `used_chunks`에 포함
   - 청크3, 4, 5는 제외 (인용 안 됨)

5. **프론트엔드 표시**:
   ```
   [팩트 체크]
   
   📄 2026학년도 경희대 정시모집요강.pdf
   원문: "경영학과 모집인원: 정시 나군 50명 (일반전형 40명, 지역인재 10명)..."
   [자료 다운]
   
   📄 2025학년도 경희대 입시결과.pdf
   원문: "경영학과(나군) 지원인원 765명, 경쟁률 15.3:1, 70% 커트라인 654.12점..."
   [자료 다운]
   ```

---

## 💡 왜 이렇게 설계했나?

### 1. **투명성**
- AI가 어떤 자료를 보고 답변했는지 명확히 공개
- "헛소리" 방지

### 2. **신뢰성**
- 사용자가 원문을 직접 확인 가능
- AI 해석이 맞는지 검증 가능

### 3. **효율성**
- 검색한 10개 청크 중 2개만 실제 사용
- 사용자에게는 2개만 보여줌 (불필요한 정보 제거)

### 4. **가독성**
- 같은 문서는 한 번만 표시 (중복 제거)
- 접기/펼치기 기능으로 선택적 확인

---

## 📝 데이터 흐름 요약

```python
# 1. 백엔드 응답
{
    "final_answer": "경영학과는 <cite>50명</cite>을 선발합니다.",
    "used_chunks": [
        {
            "id": "abc-123",
            "content": "경영학과 모집인원: 나군 50명...",
            "title": "경희대학교 2026학년도 모집요강",
            "source": "2026학년도 경희대 정시모집요강.pdf",
            "file_url": "https://supabase.co/.../khu_2026.pdf"
        }
    ]
}

# 2. 프론트엔드 표시
- 답변 영역: "경영학과는 50명을 선발합니다."
- 팩트 체크 (접기/펼치기):
  └─ 📄 2026학년도 경희대 정시모집요강.pdf
     원문: "경영학과 모집인원: 나군 50명..."
     [자료 다운] 버튼
```

---

**작성일**: 2026년 1월 23일  
**버전**: 1.0
