# ì ìˆ˜ ì‚°ì¶œ ë°©ë²• ë¬¸ì„œ - ì½”ë“œë¡œ ê°•ì œ ì¶”ê°€

## ğŸ¯ ë³€ê²½ ì‚¬í•­

**ìš”êµ¬ì‚¬í•­**: í”„ë¡¬í”„íŠ¸ê°€ ì•„ë‹Œ ì½”ë“œë¡œ extracted_scoresê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ citation ì¶”ê°€

---

## âœ… êµ¬í˜„ ì™„ë£Œ

### 1. ConsultingAgent.execute ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ë³€ê²½

**íŒŒì¼**: `backend/services/multi_agent/sub_agents.py:494`

```python
# Before
async def execute(self, query: str) -> Dict[str, Any]:

# After
async def execute(self, query: str, extracted_scores: Dict[str, Any] = None) -> Dict[str, Any]:
```

**ë³€ê²½ ë‚´ìš©**:
- `extracted_scores` íŒŒë¼ë¯¸í„° ì¶”ê°€
- ì „ë‹¬ë°›ì€ extracted_scores í™•ì¸ ë¡œê·¸ ì¶”ê°€

---

### 2. Citation ì¶”ê°€ ì¡°ê±´ ë³€ê²½

**íŒŒì¼**: `backend/services/multi_agent/sub_agents.py:736-748`

```python
# Before (normalized_scores ì¡°ê±´)
if normalized_scores and normalized_scores.get("ê³¼ëª©ë³„_ì„±ì "):
    conversion_guide_url = os.getenv("SCORE_CONVERSION_GUIDE_URL", ...)
    citations.append({...})

# After (extracted_scores ì¡°ê±´)
if extracted_scores:
    conversion_guide_url = os.getenv("SCORE_CONVERSION_GUIDE_URL", ...)
    citations.append({
        "text": "ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²•",
        "source": "2026í•™ë…„ë„ ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²• ì•ˆë‚´ (ìœ ë‹ˆë¡œë“œ)",
        "url": conversion_guide_url
    })
    _log(f"   âœ… ì ìˆ˜ ì‚°ì¶œ ë°©ë²• ë¬¸ì„œ citation ê°•ì œ ì¶”ê°€ (extracted_scores ì¡´ì¬)")
```

**í•µì‹¬ ë³€ê²½**:
- ì¡°ê±´: `normalized_scores` â†’ `extracted_scores`
- ì˜ë¯¸: ì„±ì  ì „ì²˜ë¦¬ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´, **extracted_scoresë§Œ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì¶”ê°€**

---

### 3. execute_sub_agentsì—ì„œ extracted_scores ì „ë‹¬

**íŒŒì¼**: `backend/services/multi_agent/sub_agents.py:2210-2219`

```python
# Before
agent = get_agent(agent_name)
result = await agent.execute(query)

# After
agent = get_agent(agent_name)

# ì»¨ì„¤íŒ… agentì—ëŠ” extracted_scores ì „ë‹¬
if "ì»¨ì„¤íŒ…" in agent_name and extracted_scores:
    result = await agent.execute(query, extracted_scores=extracted_scores)
else:
    result = await agent.execute(query)
```

**ë³€ê²½ ë‚´ìš©**:
- ì»¨ì„¤íŒ… agent í˜¸ì¶œ ì‹œ extracted_scoresë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬
- ë‹¤ë¥¸ agentëŠ” ê¸°ì¡´ ë°©ì‹ ìœ ì§€ (queryë§Œ ì „ë‹¬)

---

### 4. sources ëª©ë¡ë„ extracted_scores ì¡°ê±´ìœ¼ë¡œ ë³€ê²½

**íŒŒì¼**: `backend/services/multi_agent/sub_agents.py:754-759`

```python
# Before
if normalized_scores and normalized_scores.get("ê³¼ëª©ë³„_ì„±ì "):
    sources.append("ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²•")

# After
if extracted_scores:
    sources.append("ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²•")
```

---

### 5. í”„ë¡¬í”„íŠ¸ì—ì„œ ê°•ì œ ì§€ì‹œ ì œê±°

**íŒŒì¼**: `backend/services/multi_agent/agent_prompts.py`

#### Before (ê°•ì œ ì§€ì‹œ - ì œê±°ë¨)
```python
3. **ì¸ìš©(Citation) - í•„ìˆ˜ ê·œì¹™:**
   - **ì•„ë˜ [ì°¸ê³  ë¬¸í—Œ] ëª©ë¡ì— ìˆëŠ” ëª¨ë“  ë¬¸ì„œëŠ” ë°˜ë“œì‹œ ë‹µë³€ ì–´ë”˜ê°€ì—ì„œ ì¸ìš©í•˜ì‹­ì‹œì˜¤.**
     íŠ¹íˆ "ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²•"ì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ ì‚¬ìš©í•˜ì„¸ìš”.

[ì°¸ê³  ë¬¸í—Œ ëª©ë¡ - ë°˜ë“œì‹œ ì‚¬ìš©]
ì•„ë˜ ë¬¸ì„œë“¤ì€ Sub Agentê°€ ìˆ˜ì§‘í•œ ìë£Œì…ë‹ˆë‹¤. ì´ ì¤‘ ìµœì†Œ 1ê°œ ì´ìƒì€ ë°˜ë“œì‹œ ë‹µë³€ì—ì„œ ì¸ìš©í•˜ì‹­ì‹œì˜¤.
íŠ¹íˆ "ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²•"ì´ ìˆìœ¼ë©´ í•™ìƒ ì„±ì  ë¶„ì„ ì‹œ ë°˜ë“œì‹œ cite íƒœê·¸ë¡œ í¬í•¨í•˜ì„¸ìš”.

âš ï¸ ì¤‘ìš”: [ì°¸ê³  ë¬¸í—Œ]ì— ìˆëŠ” ë¬¸ì„œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì¶œì²˜ê°€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤!
```

#### After (ìì—°ìŠ¤ëŸ¬ìš´ ì•ˆë‚´)
```python
3. **ì¸ìš©(Citation):**
   - [fact_check], [analysis], [recommendation], [warning] ì„¹ì…˜ì—ì„œ 
     Sub Agent ê²°ê³¼ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” `<cite>` íƒœê·¸ë¥¼ ì¶”ê°€í•˜ì‹­ì‹œì˜¤.
   - Sub Agentê°€ ì œê³µí•œ ë°ì´í„°ë¥¼ ì–¸ê¸‰í•  ë•Œ cite íƒœê·¸ë¡œ ê°ì‹¸ë©´ ì¶œì²˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.

[ì°¸ê³  ë¬¸í—Œ ëª©ë¡]
ì•„ë˜ëŠ” Sub Agentê°€ ìˆ˜ì§‘í•œ ìë£Œì…ë‹ˆë‹¤. ë‹µë³€ ì‘ì„± ì‹œ í•„ìš”í•œ ê²½ìš° cite íƒœê·¸ë¡œ ì¸ìš©í•˜ì„¸ìš”.
```

**ë³€ê²½ ì´ìœ **:
- ì½”ë“œë¡œ ê°•ì œí•˜ë¯€ë¡œ í”„ë¡¬í”„íŠ¸ì—ì„œ "ë°˜ë“œì‹œ", "ë¬´ì¡°ê±´" ë“±ì˜ ê°•ì œ ì§€ì‹œ ë¶ˆí•„ìš”
- LLMì—ê²Œ ìì—°ìŠ¤ëŸ½ê²Œ cite íƒœê·¸ ì‚¬ìš© ì•ˆë‚´ë§Œ ì œê³µ

---

## ğŸ“Š ë™ì‘ íë¦„

```
ì‚¬ìš©ì ì§ˆë¬¸: "ì •ì‹œì— êµ­ì–´ 92ì , ìˆ˜í•™ 85ì , ì˜ì–´ 88ì , ìƒí™œê³¼ìœ¤ë¦¬ 90ì , ì‚¬íšŒë¬¸í™” 87ì ì„ ë§ì•˜ëŠ”ë° ì–´ë”” ê°ˆ ìˆ˜ ìˆì–´?"
   â†“
[Orchestration Agent]
   - ì§ˆë¬¸ íŒŒì‹±
   - extracted_scores ìƒì„±:
     {
       "êµ­ì–´": {"type": "ì›ì ìˆ˜", "value": 92},
       "ìˆ˜í•™": {"type": "ì›ì ìˆ˜", "value": 85},
       ...
     }
   â†“
[execute_sub_agents]
   - ì»¨ì„¤íŒ… agent í˜¸ì¶œ ê°ì§€
   - agent.execute(query, extracted_scores=extracted_scores) í˜¸ì¶œ
   â†“
[ConsultingAgent.execute]
   - extracted_scores ì „ë‹¬ë°›ìŒ âœ…
   - score_preprocessing ì‹¤í–‰ (normalized_scores ìƒì„±)
   - Gemini LLMìœ¼ë¡œ ë‹µë³€ ìƒì„±
   - citations êµ¬ì„±:
     if extracted_scores:  â† ì´ ì¡°ê±´ë§Œ ì²´í¬!
         citations.append({
             "text": "ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²•",
             "source": "2026í•™ë…„ë„ ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²• ì•ˆë‚´ (ìœ ë‹ˆë¡œë“œ)",
             "url": "https://..."
         })
   - return { ..., "citations": citations }
   â†“
[Final Agent]
   - citations ë°›ìŒ
   - LLMì´ ë‹µë³€ì— cite íƒœê·¸ ì¶”ê°€ (í”„ë¡¬í”„íŠ¸ ì•ˆë‚´)
   - íŒ©íŠ¸ì²´í¬ìš© used_chunks ì¶”ì¶œ
   â†“
[í”„ë¡ íŠ¸ì—”ë“œ]
   - used_chunks í‘œì‹œ
   - "ğŸ“„ ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²•" ë²„íŠ¼ í‘œì‹œ âœ…
```

---

## ğŸ” í•µì‹¬ ì°¨ì´ì 

### Before (normalized_scores ì¡°ê±´)
```python
if normalized_scores and normalized_scores.get("ê³¼ëª©ë³„_ì„±ì "):
    # citation ì¶”ê°€
```

**ë¬¸ì œì **:
- `score_preprocessing`ì´ ì‹¤íŒ¨í•˜ë©´ citation ì¶”ê°€ ì•ˆ ë¨
- ì„±ì  ì „ì²˜ë¦¬ ë¡œì§ì— ì˜ì¡´ì 

### After (extracted_scores ì¡°ê±´)
```python
if extracted_scores:
    # citation ë¬´ì¡°ê±´ ì¶”ê°€
```

**ì¥ì **:
- âœ… Orchestrationì´ ì„±ì ì„ ì¶”ì¶œí•˜ê¸°ë§Œ í•˜ë©´ ë¬´ì¡°ê±´ ì¶”ê°€
- âœ… ì „ì²˜ë¦¬ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ë¬´ê´€
- âœ… ê°„ë‹¨í•˜ê³  ëª…í™•í•œ ì¡°ê±´

---

## ğŸ“ ì‹œë‚˜ë¦¬ì˜¤ë³„ ë™ì‘

### âœ… Case 1: ì„±ì  í¬í•¨ ì§ˆë¬¸
```
ì§ˆë¬¸: "ì •ì‹œì— êµ­ì–´ 92ì , ìˆ˜í•™ 85ì , ì˜ì–´ 88ì , ìƒí™œê³¼ìœ¤ë¦¬ 90ì , ì‚¬íšŒë¬¸í™” 87ì ì„ ë§ì•˜ëŠ”ë° ì–´ë”” ê°ˆ ìˆ˜ ìˆì–´?"

1. Orchestration â†’ extracted_scores = { êµ­ì–´: {...}, ìˆ˜í•™: {...}, ... }
2. ConsultingAgent.execute(query, extracted_scores={...})
3. if extracted_scores: â† True
4. citations.append(ì ìˆ˜ ë³€í™˜ ë¬¸ì„œ) âœ…
5. í”„ë¡ íŠ¸ì—”ë“œ íŒ©íŠ¸ì²´í¬ì— í‘œì‹œ âœ…
```

### âŒ Case 2: ì„±ì  ì—†ëŠ” ì§ˆë¬¸
```
ì§ˆë¬¸: "ê²½í¬ëŒ€ ì •ì‹œ ì–´ë•Œ?"

1. Orchestration â†’ extracted_scores = {}
2. ConsultingAgent í˜¸ì¶œ ì•ˆ ë˜ê±°ë‚˜, í˜¸ì¶œë˜ì–´ë„ extracted_scores=None
3. if extracted_scores: â† False
4. citation ì¶”ê°€ ì•ˆ ë¨ âŒ (ì •ìƒ ë™ì‘)
5. íŒ©íŠ¸ì²´í¬ì— ë‹¤ë¥¸ ë¬¸ì„œë§Œ í‘œì‹œ
```

### âš ï¸ Case 3: ì„±ì  ë¶ˆì¶©ë¶„ (1-2ê°œë§Œ)
```
ì§ˆë¬¸: "êµ­ì–´ 92ì ì¸ë° ì–´ë”” ê°ˆ ìˆ˜ ìˆì–´?"

1. Orchestration â†’ extracted_scores = { êµ­ì–´: {...} }
2. ConsultingAgent.execute(query, extracted_scores={...})
3. if extracted_scores: â† True
4. citations.append(ì ìˆ˜ ë³€í™˜ ë¬¸ì„œ) âœ…
5. í”„ë¡ íŠ¸ì—”ë“œ íŒ©íŠ¸ì²´í¬ì— í‘œì‹œ âœ…
```

**ì°¨ì´ì **: 
- Before: 1-2ê°œ ê³¼ëª©ì€ ì „ì²˜ë¦¬ ì‹¤íŒ¨ ê°€ëŠ¥ â†’ citation ì¶”ê°€ ì•ˆ ë  ìˆ˜ ìˆìŒ
- After: extracted_scoresë§Œ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì¶”ê°€ â†’ í•­ìƒ í‘œì‹œ

---

## ğŸš€ ì ìš© ë°©ë²•

### 1. ë°±ì—”ë“œ ì¬ì‹œì‘ (í•„ìˆ˜)
```bash
# ë°±ì—”ë“œ í„°ë¯¸ë„ (Ctrl+C í›„)
cd backend
uvicorn main:app --reload
```

### 2. í…ŒìŠ¤íŠ¸
```
ì§ˆë¬¸: ì •ì‹œì— êµ­ì–´ 92ì , ìˆ˜í•™ 85ì , ì˜ì–´ 88ì , ìƒí™œê³¼ìœ¤ë¦¬ 90ì , ì‚¬íšŒë¬¸í™” 87ì ì„ ë§ì•˜ëŠ”ë° ì–´ë”” ê°ˆ ìˆ˜ ìˆì–´?

ê¸°ëŒ€ ê²°ê³¼:
1. ë‹µë³€ ìƒì„±
2. íŒ©íŠ¸ì²´í¬ ì„¹ì…˜ í‘œì‹œ
3. "ğŸ“„ ìˆ˜ëŠ¥ ì ìˆ˜ ë³€í™˜ ë° ì¶”ì • ë°©ë²•" ë¬¸ì„œ 100% í‘œì‹œ âœ…
```

---

## ğŸ’¡ ì¥ì 

### 1. ì‹ ë¢°ì„± í–¥ìƒ
- âœ… í”„ë¡¬í”„íŠ¸ì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ
- âœ… LLMì´ cite íƒœê·¸ë¥¼ ìƒëµí•´ë„ citationì€ í•­ìƒ ì¶”ê°€ë¨
- âœ… ì½”ë“œ ë ˆë²¨ì—ì„œ ê°•ì œ

### 2. ë‹¨ìˆœì„±
- Before: `normalized_scores and normalized_scores.get("ê³¼ëª©ë³„_ì„±ì ")`
- After: `extracted_scores`
- â†’ ì¡°ê±´ì´ ê°„ë‹¨í•˜ê³  ëª…í™•

### 3. ë…ë¦½ì„±
- `score_preprocessing` ì‹¤íŒ¨ ì—¬ë¶€ì™€ ë¬´ê´€
- ì „ì²˜ë¦¬ ë¡œì§ ë³€ê²½ì— ì˜í–¥ ë°›ì§€ ì•ŠìŒ

### 4. ì¼ê´€ì„±
- ì„±ì  ì…ë ¥ ì§ˆë¬¸ â†’ 100% citation í‘œì‹œ
- ì˜ˆì™¸ ìƒí™© ìµœì†Œí™”

---

## ğŸ”§ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ConsultingAgent.executeì— extracted_scores íŒŒë¼ë¯¸í„° ì¶”ê°€
- [x] citation ì¶”ê°€ ì¡°ê±´ì„ extracted_scoresë¡œ ë³€ê²½
- [x] execute_sub_agentsì—ì„œ extracted_scores ì „ë‹¬
- [x] sources ëª©ë¡ë„ extracted_scores ì¡°ê±´ìœ¼ë¡œ ë³€ê²½
- [x] í”„ë¡¬í”„íŠ¸ì—ì„œ ê°•ì œ ì§€ì‹œ ì œê±°
- [ ] ë°±ì—”ë“œ ì¬ì‹œì‘
- [ ] ì„±ì  í¬í•¨ ì§ˆë¬¸ í…ŒìŠ¤íŠ¸
- [ ] íŒ©íŠ¸ì²´í¬ì— ì ìˆ˜ ì‚°ì¶œ ë°©ë²• ë¬¸ì„œ í‘œì‹œ í™•ì¸

---

**ì‘ì„±ì¼**: 2026ë…„ 1ì›” 23ì¼  
**ë²„ì „**: 2.0 (ì½”ë“œ ê°•ì œ ë°©ì‹)  
**ìƒíƒœ**: êµ¬í˜„ ì™„ë£Œ, í…ŒìŠ¤íŠ¸ ëŒ€ê¸°
