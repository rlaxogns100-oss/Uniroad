# íŒ©íŠ¸ì²´í¬ ê¸°ëŠ¥ì´ ë‚˜ì™”ë‹¤ ì•ˆ ë‚˜ì™”ë‹¤ í•˜ëŠ” ë¬¸ì œ

## ğŸ” ë¬¸ì œ ìƒí™©

ì‚¬ìš©ìê°€ ì§ˆë¬¸í•  ë•Œë§ˆë‹¤ ë‹µë³€ í•˜ë‹¨ì˜ **"íŒ©íŠ¸ ì²´í¬"** ì„¹ì…˜ì´:
- âœ… ì–´ë–¤ ì§ˆë¬¸ì—ì„œëŠ” ë‚˜íƒ€ë‚¨
- âŒ ì–´ë–¤ ì§ˆë¬¸ì—ì„œëŠ” ì•ˆ ë‚˜íƒ€ë‚¨

---

## ğŸ§© ì›ì¸ ë¶„ì„

### 1. íŒ©íŠ¸ì²´í¬ í‘œì‹œ ì¡°ê±´

**í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ** (`ChatMessage.tsx:48-131`):
```tsx
{!isUser && used_chunks && used_chunks.length > 0 && (
  <details>
    <summary>íŒ©íŠ¸ ì²´í¬</summary>
    {/* ... */}
  </details>
)}
```

**í‘œì‹œ ì¡°ê±´**: `used_chunks`ê°€ **ì¡´ì¬í•˜ê³ ** **1ê°œ ì´ìƒ**ì¼ ë•Œë§Œ í‘œì‹œ

### 2. `used_chunks`ê°€ ìƒì„±ë˜ëŠ” ê³¼ì •

#### Step 1: Sub Agentê°€ ë¬¸ì„œ ê²€ìƒ‰
```python
# ì˜ˆ: ê²½í¬ëŒ€ agent
results = supabase.search_documents(
    query="ê²½í¬ëŒ€ 2026 ì •ì‹œ",
    k=5
)
# â†’ 5ê°œ ì²­í¬ ë°˜í™˜
```

#### Step 2: Final Agentê°€ ë‹µë³€ ìƒì„±
```python
# LLMì—ê²Œ ì²­í¬ ì œê³µí•˜ë©° ë‹µë³€ ìƒì„±
prompt = f"""
[Sub Agent ê²°ê³¼]
{all_chunks}

[ì§€ì‹œì‚¬í•­]
ì¶œì²˜ê°€ ìˆëŠ” ì •ë³´ëŠ” <cite> íƒœê·¸ë¡œ ê°ì‹¸ì„¸ìš”
"""

# LLM ì‘ë‹µ:
answer = "<cite data-source='ê²½í¬ëŒ€.pdf'>50ëª… ì„ ë°œ</cite>"
# ë˜ëŠ”
answer = "50ëª… ì„ ë°œ"  # âŒ cite íƒœê·¸ ì—†ìŒ
```

#### Step 3: ì¸ìš©ëœ ì²­í¬ë§Œ ì¶”ì¶œ
```python
def _extract_cited_chunks_only(answer, chunks):
    # ë‹µë³€ì—ì„œ <cite> íƒœê·¸ íŒŒì‹±
    cited_sources = set()
    for match in re.finditer(r'<cite\s+data-source="([^"]*)"', answer):
        cited_sources.add(match.group(1))
    
    # âœ… cite íƒœê·¸ ìˆìŒ â†’ cited_sources = {"ê²½í¬ëŒ€.pdf"}
    # âŒ cite íƒœê·¸ ì—†ìŒ â†’ cited_sources = {} (ë¹ˆ set)
    
    if not cited_sources:
        print("âš ï¸ ë‹µë³€ì— <cite> íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤")
        return []  # â† ë¹ˆ ë°°ì—´ ë°˜í™˜
    
    # cited_sourcesì— í•´ë‹¹í•˜ëŠ” ì²­í¬ë§Œ í•„í„°ë§
    used_chunks = [c for c in chunks if c['source'] in cited_sources]
    return used_chunks
```

**ê²°ê³¼**:
- `answer`ì— `<cite>` íƒœê·¸ ìˆìŒ â†’ `used_chunks = [ì²­í¬1, ì²­í¬2]` â†’ âœ… íŒ©íŠ¸ì²´í¬ í‘œì‹œ
- `answer`ì— `<cite>` íƒœê·¸ ì—†ìŒ â†’ `used_chunks = []` â†’ âŒ íŒ©íŠ¸ì²´í¬ ìˆ¨ê¹€

---

## â— í•µì‹¬ ë¬¸ì œ: LLMì´ cite íƒœê·¸ë¥¼ ì¼ê´€ì„± ì—†ê²Œ ì‚¬ìš©

### í˜„ì¬ í”„ë¡¬í”„íŠ¸ (prompt5)

**íŒŒì¼**: `backend/services/multi_agent/agent_prompts.py:683-684`
```python
3. **ì¸ìš©(Citation):**
   - ë°ì´í„°ì˜ ì‹ ë¢°ë„ë¥¼ ìœ„í•´ ê·¼ê±°ê°€ ë˜ëŠ” ë¶€ë¶„ í•˜ë‹¨ì—ëŠ” 
     ë°˜ë“œì‹œ `<cite>` íƒœê·¸ë¥¼ í¬í•¨í•˜ì‹­ì‹œì˜¤.
```

### ë¬¸ì œì 

1. **ì• ë§¤í•œ ì¡°ê±´**: "ê·¼ê±°ê°€ ë˜ëŠ” ë¶€ë¶„"ì´ ë¬´ì—‡ì¸ì§€ ëª…í™•í•˜ì§€ ì•ŠìŒ
2. **ì£¼ê´€ì  íŒë‹¨**: LLMì´ ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•˜ì—¬ cite íƒœê·¸ ì¶”ê°€/ìƒëµ
3. **ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¼ ë‹¤ë¦„**:
   - ğŸ“Š **ë°ì´í„° ì§ˆë¬¸** (ì…ê²°, ëª¨ì§‘ìš”ê°•) â†’ cite íƒœê·¸ ì‚¬ìš© í™•ë¥  **ë†’ìŒ**
   - ğŸ’¬ **ì¶”ìƒì  ì§ˆë¬¸** (ì¡°ì–¸, ê²©ë ¤) â†’ cite íƒœê·¸ ì‚¬ìš© í™•ë¥  **ë‚®ìŒ**

### ì‹¤ì œ ì˜ˆì‹œ

#### âœ… Case 1: cite íƒœê·¸ ìƒì„±ë¨ (íŒ©íŠ¸ì²´í¬ ë‚˜íƒ€ë‚¨)

**ì§ˆë¬¸**: "ê²½í¬ëŒ€ ì •ì‹œì—ì„œ ê²½ì˜í•™ê³¼ëŠ” ëª‡ ëª… ë½‘ì•„?"

**Final Agent ì‘ë‹µ**:
```
ã€2026í•™ë…„ë„ ê²½í¬ëŒ€ ì •ì‹œã€‘
<cite data-source="2026í•™ë…„ë„ ê²½í¬ëŒ€ ì •ì‹œëª¨ì§‘ìš”ê°•.pdf" data-url="...">
ê²½ì˜í•™ê³¼ëŠ” ì •ì‹œ ë‚˜êµ°ì—ì„œ 50ëª…ì„ ì„ ë°œí•©ë‹ˆë‹¤.
</cite>
```

**ê²°ê³¼**:
- `_extract_cited_chunks_only` â†’ `cited_sources = {"2026í•™ë…„ë„ ê²½í¬ëŒ€ ì •ì‹œëª¨ì§‘ìš”ê°•.pdf"}`
- `used_chunks = [ì²­í¬1]`
- âœ… **íŒ©íŠ¸ì²´í¬ í‘œì‹œ**

---

#### âŒ Case 2: cite íƒœê·¸ ìƒì„± ì•ˆ ë¨ (íŒ©íŠ¸ì²´í¬ ìˆ¨ê¹€)

**ì§ˆë¬¸**: "ê²½í¬ëŒ€ì— ì§€ì›í•˜ë ¤ëŠ”ë° ì¡°ì–¸í•´ì¤˜"

**Final Agent ì‘ë‹µ**:
```
ê²½í¬ëŒ€ëŠ” ìˆ˜ì‹œì™€ ì •ì‹œ ëª¨ë‘ ê¸°íšŒê°€ ìˆìŠµë‹ˆë‹¤. 
í˜„ì¬ ì„±ì ìœ¼ë¡œ ì–´ë–¤ ì „í˜•ì´ ìœ ë¦¬í•œì§€ í™•ì¸í•´ë³´ì„¸ìš”.
ë‹¤ìŒ ë‹¨ê³„ë¡œ êµ¬ì²´ì ì¸ í•™ê³¼ì™€ ì„±ì ì„ ì•Œë ¤ì£¼ì‹œë©´ 
ë” ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
```

**ê²°ê³¼**:
- `_extract_cited_chunks_only` â†’ `cited_sources = {}` (ë¹ˆ set)
- `used_chunks = []`
- âŒ **íŒ©íŠ¸ì²´í¬ ìˆ¨ê¹€**

---

## ğŸ“Š cite íƒœê·¸ ìƒì„± íŒ¨í„´ ë¶„ì„

### LLMì´ cite íƒœê·¸ë¥¼ **ìƒì„±í•˜ëŠ”** ê²½ìš°

| ì§ˆë¬¸ ìœ í˜• | ì˜ˆì‹œ | cite ìƒì„± í™•ë¥  |
|----------|------|--------------|
| ì…ì‹œê²°ê³¼ ì¡°íšŒ | "ì‘ë…„ ê²½í¬ëŒ€ ê²½ì˜í•™ê³¼ ì»¤íŠ¸ë¼ì¸?" | â­â­â­â­â­ 90% |
| ëª¨ì§‘ìš”ê°• ì¡°íšŒ | "ê²½í¬ëŒ€ 2026 ì •ì‹œ ëª‡ ëª… ë½‘ì•„?" | â­â­â­â­â­ 90% |
| í™˜ì‚°ì ìˆ˜ ê³„ì‚° | "ë‚´ ì ìˆ˜ë¡œ ê²½í¬ëŒ€ ê°ˆ ìˆ˜ ìˆì–´?" | â­â­â­â­ 80% |
| í•™ê³¼ ë¹„êµ | "ê²½í¬ëŒ€ vs ì™¸ëŒ€ ì–´ë””ê°€ ì¢‹ì•„?" | â­â­â­ 60% |

### LLMì´ cite íƒœê·¸ë¥¼ **ìƒì„± ì•ˆ í•˜ëŠ”** ê²½ìš°

| ì§ˆë¬¸ ìœ í˜• | ì˜ˆì‹œ | cite ìƒì„± í™•ë¥  |
|----------|------|--------------|
| ì¼ë°˜ ì¡°ì–¸ | "ì •ì‹œ ì¤€ë¹„ ì–´ë–»ê²Œ í•´?" | â­ 20% |
| ê²©ë ¤ ìš”ì²­ | "ë¶ˆì•ˆí•´, ì‘ì›í•´ì¤˜" | â­ 10% |
| ì¶”ìƒì  ì§ˆë¬¸ | "ë‚´ ë¯¸ë˜ê°€ ì–´ë–¨ê¹Œ?" | â­ 10% |
| ì„±ì  ì—†ëŠ” ìƒë‹´ | "ê²½í¬ëŒ€ ì–´ë•Œ?" | â­â­ 30% |

---

## ğŸ” ì½”ë“œ íë¦„ ìƒì„¸

```python
# final_agent.py:307-376

def _extract_cited_chunks_only(answer, chunks):
    # 1. ë‹µë³€ì—ì„œ <cite> íƒœê·¸ íŒŒì‹±
    cite_pattern = r'<cite\s+data-source="([^"]*)"(?:\s+data-url="([^"]*)")?\s*>.*?</cite>'
    cited_sources = set()
    
    for match in re.finditer(cite_pattern, answer):
        source = match.group(1)
        cited_sources.add(source)
    
    # 2. cite íƒœê·¸ ì—†ìœ¼ë©´ ê²½ê³  + ë¹ˆ ë°°ì—´ ë°˜í™˜
    if not cited_sources:
        _log("âš ï¸ ë‹µë³€ì— <cite> íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ì¶œì²˜ ì—†ì´ ë‹µë³€ ìƒì„±ë¨.")
        return []  # â† ì´ ë¶€ë¶„!!!
    
    # 3. ì¸ìš©ëœ ì¶œì²˜ì— í•´ë‹¹í•˜ëŠ” ì²­í¬ë§Œ í•„í„°ë§
    used_chunks = []
    for chunk in chunks:
        if chunk['source'] in cited_sources:
            used_chunks.append(chunk)
    
    return used_chunks
```

**í•µì‹¬**: `cited_sources`ê°€ **ë¹„ì–´ìˆìœ¼ë©´** â†’ `return []` â†’ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ íŒ©íŠ¸ì²´í¬ ìˆ¨ê¹€

---

## âœ… í•´ê²° ë°©ë²•

### ë°©ë²• 1: í”„ë¡¬í”„íŠ¸ ê°•í™” (ê¶Œì¥) â­

**í˜„ì¬ (ì• ë§¤í•¨)**:
```
ë°ì´í„°ì˜ ì‹ ë¢°ë„ë¥¼ ìœ„í•´ ê·¼ê±°ê°€ ë˜ëŠ” ë¶€ë¶„ í•˜ë‹¨ì—ëŠ” 
ë°˜ë“œì‹œ <cite> íƒœê·¸ë¥¼ í¬í•¨í•˜ì‹­ì‹œì˜¤.
```

**ê°œì„ ì•ˆ (ëª…í™•í•¨)**:
```
3. **ì¸ìš©(Citation) - í•„ìˆ˜ ê·œì¹™:**
   - [fact_check], [analysis], [recommendation] ì„¹ì…˜ì—ì„œëŠ”
     Sub Agent ê²°ê³¼ë¥¼ ì‚¬ìš©í•  ë•Œ **ë°˜ë“œì‹œ ë§¤ë²ˆ** <cite> íƒœê·¸ë¥¼ ì¶”ê°€í•˜ì‹­ì‹œì˜¤.
   - í˜•ì‹: <cite data-source="ë¬¸ì„œëª…" data-url="URL">ì¸ìš© ë‚´ìš©</cite>
   - ì˜ˆì™¸: [empathy], [encouragement], [next_step] ì„¹ì…˜ë§Œ cite ìƒëµ ê°€ëŠ¥
   
   âŒ ì˜ëª»ëœ ì˜ˆ:
   ê²½ì˜í•™ê³¼ëŠ” 50ëª…ì„ ì„ ë°œí•©ë‹ˆë‹¤.
   
   âœ… ì˜¬ë°”ë¥¸ ì˜ˆ:
   <cite data-source="2026 ê²½í¬ëŒ€ ì •ì‹œëª¨ì§‘ìš”ê°•.pdf" data-url="...">
   ê²½ì˜í•™ê³¼ëŠ” 50ëª…ì„ ì„ ë°œí•©ë‹ˆë‹¤.
   </cite>
```

### ë°©ë²• 2: ê°•ì œ cite íƒœê·¸ ì‚½ì… (ë°±ì—”ë“œ ìˆ˜ì •)

```python
def _extract_cited_chunks_only(answer, chunks):
    cited_sources = set()
    
    for match in re.finditer(cite_pattern, answer):
        cited_sources.add(match.group(1))
    
    if not cited_sources:
        _log("âš ï¸ cite íƒœê·¸ ì—†ìŒ â†’ ì²« ë²ˆì§¸ ì²­í¬ë¥¼ ê°•ì œ ì¶”ê°€")
        # ê²€ìƒ‰ëœ ì²­í¬ê°€ ìˆìœ¼ë©´ ìµœì†Œ 1ê°œëŠ” í‘œì‹œ
        if chunks:
            return [chunks[0]]  # ì²« ë²ˆì§¸ ì²­í¬ ë°˜í™˜
        return []
    
    # ... ë‚˜ë¨¸ì§€ ë¡œì§
```

**ì¥ì **: cite íƒœê·¸ê°€ ì—†ì–´ë„ íŒ©íŠ¸ì²´í¬ í‘œì‹œë¨  
**ë‹¨ì **: ì‹¤ì œë¡œ ì¸ìš© ì•ˆ í•œ ë¬¸ì„œë„ í‘œì‹œë  ìˆ˜ ìˆìŒ (ë¶€ì •í™•)

### ë°©ë²• 3: fact_check ì„¹ì…˜ì—ë§Œ ê°•ì œ ì ìš©

```python
# orchestration_agent.pyì—ì„œ
answer_structure = [
    {
        "section": 1,
        "type": "empathy"  # cite ìƒëµ ê°€ëŠ¥
    },
    {
        "section": 2,
        "type": "fact_check",  # cite í•„ìˆ˜!
        "require_citation": True  # â† í”Œë˜ê·¸ ì¶”ê°€
    }
]
```

---

## ğŸ“ ì •ë¦¬

### ë¬¸ì œ ìš”ì•½
1. Final Agentê°€ `<cite>` íƒœê·¸ë¥¼ **ì¼ê´€ì„± ì—†ê²Œ** ì‚¬ìš©
2. cite íƒœê·¸ê°€ ì—†ìœ¼ë©´ â†’ `used_chunks = []`
3. `used_chunks`ê°€ ë¹„ì–´ìˆìœ¼ë©´ â†’ íŒ©íŠ¸ì²´í¬ ì„¹ì…˜ ìˆ¨ê¹€

### ê·¼ë³¸ ì›ì¸
- í”„ë¡¬í”„íŠ¸ì˜ "ê·¼ê±°ê°€ ë˜ëŠ” ë¶€ë¶„"ì´ë¼ëŠ” **ì• ë§¤í•œ ì¡°ê±´**
- LLMì´ ì£¼ê´€ì ìœ¼ë¡œ íŒë‹¨í•˜ì—¬ cite íƒœê·¸ ì¶”ê°€/ìƒëµ

### í•´ê²°ì±… (ê¶Œì¥)
**Prompt 5ë¥¼ ê°œì„ **í•˜ì—¬ cite íƒœê·¸ ì‚¬ìš© ê·œì¹™ì„ ë” ëª…í™•í•˜ê³  ê°•ì œì ìœ¼ë¡œ ë§Œë“¤ê¸°

---

**ì‘ì„±ì¼**: 2026ë…„ 1ì›” 23ì¼  
**ë²„ì „**: 1.0
